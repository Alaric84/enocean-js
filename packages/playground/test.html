<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <style>
     #logger{padding:10px;background:#333;color:#ddd;width:550px;height:200px;overflow:scroll;}
    </style>
  </head>
  <body>
    <div id="info">
      <div>Base Id: <span id="elem_baseid"></span></div>
      <div>remaining write cycles: <span id="elem_rwc"></span></div>
    </div>
    <button id="slp_btn">sleep for 10s</button>
    <button id="getId_btn">getId</button>

    <button id="light_on_btn">ON</button>
    <button id="light_off_btn">OFF</button>

    <div id="logger">
    </div>
    <script type="module">
      import { CommonCommand } from '/node_modules/@enocean-js/common-command/src/CommonCommand.js'
      import { ESP3Packet, RadioERP1 } from '/node_modules/@enocean-js/esp3-packets/src/index.js'
      import { pretty } from '/node_modules/@enocean-js/pretty-printer/src/pretty-printer.js'
      import { WebsocketSender } from '/node_modules/@enocean-js/websocket-sender/src/websocket-sender.js'
      var socket = io('http://localhost:3000');
      var sender = WebsocketSender(socket)
      var commander = CommonCommand.connect(sender)
      var erp = RadioERP1.connect(sender)
      socket.on("data",data=>{
        var packet= ESP3Packet.from(data)
        logger.innerHTML += pretty.logESP3(packet)
        logger.scrollTop = logger.scrollHeight;
      })
      window.addEventListener("load",async ()=>{
        var base = await commander.getBaseId()
        elem_baseid.innerHTML= base.baseId
        elem_rwc.innerHTML= base.remainingWriteCycles
        const A0_DOWN = 0x10
        const A1_DOWN = 0x30
        const RELEASE = 0x00
        const id = parseInt(base.baseId,16)+1

        getId_btn.addEventListener("click",async ()=>{
          var base = await commander.getBaseId()
          elem_baseid.innerHTML= base.baseId
          elem_rwc.innerHTML= base.remainingWriteCycles
        })
        slp_btn.addEventListener("click",async ()=>{
          await commander.sleep(10000)
        })
        light_on_btn.addEventListener("click",async ()=>{
          await erp.send(0xf6,A0_DOWN,id,0x20)
          await erp.send(0xf6,RELEASE,id,0x20)
        })
        light_off_btn.addEventListener("click",async ()=>{
          await erp.send(0xf6,A1_DOWN,id,0x20)
          await erp.send(0xf6,RELEASE,id,0x20)
        })
      })
    </script>
  </body>
</html>
