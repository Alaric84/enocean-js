#!/usr/bin/env node
const SerialportSender = require('@enocean-js/serialport-sender').SerialportSender
const ESP3Parser = require('@enocean-js/serialport-parser').ESP3Parser
const SerialPort = require('serialport')

const port = new SerialPort('/dev/ttyUSB0', { baudRate: 57600 })
const parser = new ESP3Parser({ maxBufferSize: 2000 })
port.pipe(parser)
var sender = SerialportSender({ port: port, parser: new ESP3Parser({ maxBufferSize: 2000 }) })
var app = require('express')()
var http = require('http').Server(app)
var io = require('socket.io')(http)

const rateLimit = require('express-rate-limit')
const limiter = rateLimit({
  windowMs: 60 * 1000, // 15 minutes
  max: 200
})
app.use(limiter)

app.get('/', function (req, res) {
  res.sendFile(`${__dirname}/index.html`)
})

io.on('connection', function (socket) {
  socket.on('send', async function (tel) {
    try {
      var res = await sender.send(tel)
      socket.emit('response', res.getRawPacket())
    } catch (err) {
      console.log('err')
      socket.emit('error', err)
    }
  })
})

http.listen(4242, function () {
  console.log('listening on *:4242')
})

parser.on('data', data => { io.emit('data', data.toString('hex')) })
