import { Response, ESP3Packet } from '../../esp3-packets/src/index.js'

function WebsocketSender (socket) {
  return {
    send (tel, responseDefinition = { 0: [{ returnCode: 'RET_OK' }] }) {
      return new Promise((resolve, reject) => {
        const t1 = setTimeout(() => { resolve(false) }, 10500)
        const callback = data => {
          var packet = ESP3Packet.from(data)
          if (packet.packetType === 2) {
            clearTimeout(t1)
            socket.removeListener('response', callback)
            socket.removeListener('error', errCallback)
            resolve(Response.from(packet, responseDefinition))
          }
        }
        const errCallback = err => reject(err)
        socket.on('response', callback)
        socket.on('error', errCallback)
        socket.emit('send', tel)
      })
    }
  }
}
export default WebsocketSender
export { WebsocketSender }
