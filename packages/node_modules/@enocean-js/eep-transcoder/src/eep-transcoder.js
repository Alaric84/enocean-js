import * as EEP from './eep.js'
export function decode (radio, eep) {
  var c = EEP[eep.replace(/-/g, '')]
  var decoded = {}
  if (c.hasOwnProperty('ref')) {
    c = EEP[c.ref.replace(/-/g, '')]
  }
  c.case.some(function (item) {
    if (item.hasOwnProperty('condition') && item.condition.hasOwnProperty('statusfield')) {
      var s1 = 0
      for (var i = 0; i < 2; i++) {
        var mask = 1 << 7 - parseInt(item.condition.statusfield[i].bitoffs)
        if (parseInt(item.condition.statusfield[i].value) === 1) {
          s1 |= mask
        }
      }
      if (s1 === radio.status) {
        decoded = decodeCase(radio.payload, item)
        return true
      }
    } else {
      if (item.hasOwnProperty('condition') && item.condition.hasOwnProperty('datafield')) {
        const cond = radio.data.getValue(parseInt(item.condition.datafield.bitoffs), parseInt(item.condition.datafield.bitsize))
        if (parseInt(item.condition.datafield.value) === cond) {
          decoded = decodeCase(radio.payload, item)
          return true
        }
      }
      decoded = decodeCase(radio.payload, item)
    }
  })
  return Object.freeze(decoded)
}

function decodeCase (tel, c) {
  if (!Array.isArray(c.datafield)) c.datafield = [c.datafield]
  var ret = c.datafield.reduce(makeFieldExtractor(tel), {})
  return ret
}

function getDataFieldByShortcut (datafield, shortcut) {
  // returns a datafield descriptor
  return datafield.find(item => item.shortcut === shortcut)
}

function makeFieldExtractor (payload) {
  return function (ret, item, index, array) {
    // TODO: rename 'item' to 'datafield'
    var val = payload.getValue(parseInt(item.bitoffs), parseInt(item.bitsize))
    if (item.hasOwnProperty('enum') && item.enum.hasOwnProperty('item')) {
      for (var i = 0; i < item.enum.item.length; i++) {
        if (item.enum.item[i].hasOwnProperty('min')) {
          if (parseInt(item.enum.item[i].min) <= val && parseInt(item.enum.item[i].max) >= val) {
            ret[item.shortcut] = { name: item.data, value: val, desc: item.enum.item[i].description, unit: item.unit }
            return ret
          }
          // out of range
        }
        if (item.enum.item[i].hasOwnProperty('bitmask')) {
          var mask = parseInt(item.enum.item[i].bitmask)
          if ((val & mask) === parseInt(item.enum.item[i].value)) {
            ret[item.shortcut] = { name: item.data, value: item.enum.item[i].value, desc: item.enum.item[i].description, unit: item.unit }
            return ret
          }
        }
        if (item.enum.item[i].hasOwnProperty('scale') && (parseInt(item.enum.item[i].value) === val)) {
          ret[item.shortcut] = { name: item.data, value: item.enum.item[i].value, scale: item.enum.item[i].scale, desc: item.enum.item[i].description, unit: item.unit }
          return ret
        }
        if (parseInt(item.enum.item[i].value) === val) {
          ret[item.shortcut] = { name: item.data, value: val, desc: item.enum.item[i].description, unit: item.unit }
          return ret
        }
      }
    }
    if (item.hasOwnProperty('range')) {
      var rdist = Number(item.range.max) - Number(item.range.min)
      if (!item.hasOwnProperty('scale')) {
        item.scale = { min: Number(item.range.min), max: Number(item.range.max) }
      }
      var smin = Number(item.scale.min)
      var smax = Number(item.scale.max)
      if (item.scale.hasOwnProperty('ref')) {
        var func = makeFieldExtractor(payload)
        var s = func({}, getDataFieldByShortcut(array, item.scale.ref), 0, payload)[item.scale.ref].scale
        smin = Number(s.min)
        smax = Number(s.max)
      }
      var sdist = smax - smin
      var dx = (sdist / rdist)
      val = (val - Number(item.range.min)) * dx + smin
      ret[item.shortcut] = { name: item.data, value: val, unit: item.unit }
      return ret
    }
    return ret
  }
}

export function getTeachInInfo (telegram) {
  const p = telegram
  if (p.RORG === 0xa5 || p.RORG === 0xd5) {
    var rorg, func, typ, manId
    if (p.RORG === 0xd5) {
      rorg = p.RORG
      func = 0x00
      typ = 0x01
      manId = 0x00
    } else {
      rorg = p.RORG
      func = p.payload.getValue(0, 6)
      typ = p.payload.getValue(6, 7)
      manId = p.payload.getValue(13, 10)
    }
    return {
      teachInType: p.RORG === 0xa5 ? '4BS' : '1BS',
      senderId: p.senderId,
      eep: {
        rorg,
        func,
        type: typ,
        toString () {
          return `${this.rorg.toString(16).padStart(2, '0')}-${this.func.toString(16).padStart(2, '0')}-${this.type.toString(16).padStart(2, '0')}`
        }
      },
      manufacturer: {
        id: manId,
        name: ''
      }
    }
  }
  if (p.RORG === 0xf6) {
    return {
      teachInType: 'RPS',
      senderId: p.senderId,
      eep: {
        rorg: 0xf6,
        func: 0x02,
        type: 0x01,
        toString () {
          return `f6-02-01`
        }
      }
    }
  }
  if (p.RORG === 0xd4) {
    return {
      teachInType: 'UTE',
      senderId: p.senderId
    }
  }
}
