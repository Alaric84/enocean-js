import { Response } from '@enocean-js/esp3-packets'

function SerialportSender (options) {
  const parser = options.parser
  const port = options.port
  port.pipe(parser)
  return {
    send (tel, responseDefinition = { 0: [{ returnCode: 'RET_OK' }] }) {
      return new Promise((resolve, reject) => {
        const t1 = setTimeout(() => { resolve(false) }, 10500)
        const callback = data => {
          if (data.packetType === 2) {
            clearTimeout(t1)
            parser.removeListener('data', callback)
            parser.removeListener('error', errCallback)
            resolve(Response.from(data, responseDefinition))
          }
        }
        const errCallback = err => reject(err)
        parser.on('data', callback)
        parser.on('error', errCallback)
        port.write(Buffer.from(tel, 'hex'))
      })
    }
  }
}
export default SerialportSender
export { SerialportSender }
