<script type="text/javascript">
  RED.nodes.registerType('enocean-config-node', {
    category: 'config',
    defaults: {
      serialport: { value: "", required: true }
    },
    label: function () {
      return this.serialport;
    }
  });
</script>

<script type="text/x-red"
  data-template-name="enocean-config-node">
  <div class="form-row">
    <label for="node-config-input-serialport"><i class="icon-bookmark"></i> Serialport</label>
    <input type="text"
      id="node-config-input-serialport">
  </div>
</script>


<script type="text/javascript">
    RED.nodes.registerType('enocean-actor',{
        category: 'input',
        defaults: {
          serialport: {
            value: "",
            type: "enocean-config-node"
          },
          name:{
            value:"",
          },
          senderid:{
            value:"",
          },
          eep:{
            value:"",
          },
          direction:{
            value: 1
          }
        },
        outputs: 1,
        inputs: 0,
        button: {
          enabled: true,
          onclick: function (){
            console.log(this)
            fetch("inject/"+this.id,{method:"POST"})
          }
        },
        inputLabels: "LRN mode",
        color: '#063b72',
        icon: "enocean-js-white.svg",
        label: function() {
            return this.name || this.senderId || "enocean-input";
        },
        paletteLabel: 'enocean-in',
        labelStyle: 'enocean-node',
        oneditprepare:async function(){
          var res = await fetch("/context/node/"+this.id)
          var json = await res.json()
          try{
            var eep = json.default.eep.msg
            var sid = json.default.senderId.msg
          }catch(err){
            var eep = this._config.eep
            var sid = this._config.senderid
          }
          var res = await fetch(`https://enocean-js.github.io/enocean-js/eeps/${eep}.md`)
          this.info = await res.text()
          document.querySelector("#node-input-eep").setAttribute("placeholder",eep)
          document.querySelector("#node-input-senderid").setAttribute("placeholder",sid)
        }
    });
</script>

<script type="text/x-red" data-template-name="enocean-actor">
  <div class="form-row">
    <label for="node-input-serialport"><i class="fa fa-globe"></i> Serialport</label>
    <input type="text" id="node-input-serialport">
  </div>
  <div class="form-row">
    <label for="node-input-name">Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-senderid">Sender Id</label>
    <input type="text" id="node-input-senderid">
  </div>
  <div class="form-row">
    <label for="node-input-eep">EEP</label>
    <input type="text" id="node-input-eep">
  </div>
  <hr/>
  <div class="form-row">
    <label for="node-input-direction">Direction</label>
    <input type="text" id="node-input-direction">
  </div>
   <div class="form-tips">
     <b>automatic teach in: </b>just connect to a serialport. After implementing the flow, bring the node into *teach in* state and press **LRN Button** on the external device you want to pair.
   </div>
   <br/>
   <div class="form-tips">
     <b>manual teach in: </b>after connecting to a serialport, you can type in your sensors id and eep by hand.
   </div>
   <br/>
   <div class="form-tips">
     <b>direction</b> is only used in very rare cases. and usually does not have to be touched.<br/>
     the following eep might need a direction setting other than 1:
     <ul>
      <li>a5-11-05</li>
      <li>a5-20-01</li>
      <li>a5-20-02</li>
      <li>a5-20-03</li>
      <li>a5-20-04</li>
      <li>a5-20-10</li>
      <li>a5-20-11</li>
      <li>d2-a0-01</li>
     </ul>
   </div>
</script>

<script type="text/x-red" data-help-name="enocean-actor">
  <p>this is a node to listen to incomming enocean telegrams.</p>
  <h3>Output</h3>
    <dl class="message-properties">
      <dt>payload
        <span class="property-type">object</span>
      </dt>
      <dd>the decoded content of the telegram. this is dependent on the tought in sensor. for details see the node description after teaching in a sensor</dd>
    </dl>
    <dl class="message-properties">
      <dt>meta
        <span class="property-type">object</span>
      </dt>
      <dd>meta information about the telegram. Here you can find the RSSI, senderId, the raw payload, a timestamp etc.</dd>
    </dl>
  <h3>Button</h3>
    <dl class="message-properties">
      <dt>click
        <span class="property-type">event</span>
      </dt>
      <dd> set the node into the *teach in* state. you can now send **LRN Telegrams** from your device, and the sender and device will be paired (after succesfull pairing the nodes state becomes green and shows the external sensors id) </dd>
    </dl>
  <h3>Details</h3>
   <p>
     to receive some data you have to first teach in a sensor. this can be done either manually or automatically by sending an **LRN Telegram** from your device.
   </p>
</script>


<script type="text/javascript">
    RED.nodes.registerType('enocean-out',{
        category: 'output',
        defaults: {
          serialport: {
            value: "",
            type: "enocean-config-node"
          },
          name: {
            value: ""
          },
          offset: {
            value: 0
          },
          eep: {
            value: "",
            required: true
          },
          direction:{
            value: 1
          },
          data:{
            value: 0
          }
        },
        inputs:1,
        color: '#063b72',
        icon: "enocean-js-white.svg",
        align: 'right',
        label: function() {
            return this.name || "enocean-out";
        },
        paletteLabel: 'enocean-out',
        labelStyle: 'enocean-node'
    });
</script>

<script type="text/x-red" data-template-name="enocean-out">
  <div class="form-row">
    <label for="node-input-serialport"><i class="fa fa-globe"></i> Serialport</label>
    <input type="text" id="node-input-serialport">
  </div>
  <div class="form-row">
    <label for="node-input-name">Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-offset">Channel</label>
    <input type="text" id="node-input-offset">
  </div>
  <div class="form-row">
    <label for="node-input-eep">EEP</label>
    <input type="text" id="node-input-eep">
  </div>
  <hr/>
  <div class="form-row">
    <label for="node-input-direction">Direction</label>
    <input type="text" id="node-input-direction">
  </div>
  <div class="form-row">
    <label for="node-input-data">Data</label>
    <input type="text" id="node-input-data">
  </div>
</script>

<script type="text/x-red" data-help-name="enocean-out">
  <p>this is a node to send out enocean telegrams</p>
  <h3>Input</h3>
    <dl class="message-properties">
      <dt>payload
        <span class="property-type">object|string</span>
      </dt>
      <dd>send either the string *LRN* to send a learn telegram to pair with external actors, or an object that will be encoded based on the settings in this node. what can be encoded with the current EEP, the the nodes description. </dd>
    </dl>
    <dl class="message-properties">
      <dt>meta
        <span class="property-type">object</span>
      </dt>
      <dd>direction, status and data selectors (not yet implemented)</dd>
    </dl>
  <h3>Details</h3>
   <p>
     first connect to a serialport, then provide the info on what channel you want to send and which EEP should be used to encode your data.
   </p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('enocean-btn',{
        category: 'output',
        defaults: {
          serialport: {
            value: "",
            type: "enocean-config-node"
          },
          name: {
            value: ""
          }
        },
        inputs:1,
        color: '#063b72',
        icon: "enocean-js-white.svg",
        align: 'right',
        label: function() {
            return this.name || "enocean-btn";
        },
        paletteLabel: 'enocean-btn',
        labelStyle: 'enocean-node'
    });
</script>

<script type="text/x-red" data-template-name="enocean-btn">
  <div class="form-row">
    <label for="node-input-serialport"><i class="fa fa-globe"></i> Serialport</label>
    <input type="text" id="node-input-serialport">
  </div>
  <div class="form-row">
    <label for="node-input-name">Name</label>
    <input type="text" id="node-input-name">
  </div>
</script>

<script type="text/x-red" data-help-name="enocean-btn">
  <p> a specialized node, implementing a simple 2-rocker switch (4 buttons)</p>
  <h3>Properties</h3>
    <dl class="message-properties">
        <dt>Serialport
          <span class="property-type">config-node</span>
        </dt>
        <dd> the serialport to connect to </dd>
        <dt class="optional">Name
          <span class="property-type">string</span>
        </dt>
        <dd> the nodes name</dd>
    </dl>
  <h3>Inputs</h3>
    <dl class="message-properties">
      <dt>payload
        <span class="property-type">object</span>
      </dt>
      <dd>defines events, channel and button </dd>
      <dt>payload.event
        <span class="property-type">string</span>
      </dt>
      <dd>can be one of "click","down","release". Defines the event to send</dd>
      <dt>payload.button
        <span class="property-type">number</span>
      </dt>
      <dd>can be 0, 1, 2, 3 . The button to click on the simulated rocker. </dd>
      <dt>payload.channel
        <span class="property-type">number</span>
      </dt>
      <dd>can be 0-127. The channel to send on. It's an offset off the baseId of your USB 300.</dd>
    </dl>
  <h3>Details</h3>
   <p>
     this node implements a 2 Rocker Switch (4 Buttons: 0, 1, 2, 3) that can be "click"ed or "down"ed.
     "click" means the button is immediately released after beeing pressed. When "down"ed you have to release the button yourself.
     When a receiver is in LRN mode, send either `button: 0` or `button: 1` to teach in Rocker 1, or send `button: 2` or `button: 3` to teach in Rocker 2.
     With one USB you can send on up to 128 (0-127) channels. so you can simulate 256 Rocker switches.
   </p>
</script>

<style>
  .node-help td {border: 1px solid black}
  .enocean-node{
    fill:white
  }
  #palette_node_enocean-actor .palette_label{
    color:white
  }
  #palette_node_enocean-btn .palette_label{
    color:white
  }
  #palette_node_enocean-out .palette_label{
    color:white
  }
</style>
